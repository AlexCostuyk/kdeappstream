<html>
<head>
<title>
    Websocket client test
</title>
<style type="text/css">
    canvas {
        border: 1px solid black;
    }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">

function debug(msg) {
    if (console)
        console.log(msg);
}

var sessionID = '[PUT_SESSION_ID_HERE]';
var portNumber = [PUT_PORT_NUMBER_HERE];
var verbose = false;

function WSConnector(uri, options) {
    this.wsUri = uri;
    this.options = options;
}

WSConnector.prototype = {
    init:function () {
        var self = this;
        try {
            if (typeof MozWebSocket == 'function')
                WebSocket = MozWebSocket;
            this.websocket = new WebSocket(this.wsUri);
            socket = this.websocket;
            this.websocket.onopen = function () {
                debug('Connected');
            };
            this.websocket.onmessage = function (evt) {
                var data = jQuery.parseJSON(evt.data);
                if (verbose)
                    debug(data);
                qtLogic.input(data);
            };
            this.websocket.onerror = function (evt) {
                debug('Error');
                debug(evt);
            };
            this.websocket.onclose = function (evt) {
                debug('Connection closed.');
            };
        } catch (exception) {
            debug('ERROR: ' + exception);
        }

    },
    helloMessage:function () {
        this.websocket.send(sessionID);
        console.log('sent');
    }
};

function QtLogic() {
    this.widgets = {}
}

QtLogic.prototype = {
    input:function (data) {
        var self = this;
        $.each(data,function(_,value) {
            self.singleInput(value);
        });
    },
    singleInput: function(data){
        var self = this;
        if (data.w && data.h) { // has widget data
            this.widgets[data.id] = { // store
                w:data.w,
                h:data.h,
                x:data.x,
                y:data.y,
                name:data.name
            };
        }
        var widget = this.widgets[data.id];
        var renders = data.render;
        $.each(renders, function (_, value) {
            canvasDrawer.draw(value,{x: widget.x, y: widget.y});
        });
    }
};

function CanvasDrawer(canvasId) {
    this.canvas = document.getElementById(canvasId);
}

CanvasDrawer.prototype = {
    draw:function (data, translation) {
        var ctx = this.canvas.getContext("2d");
        ctx.save();
        ctx.translate(translation.x, translation.y);
        if (data.pixmap) {
            this.drawPixmap(data.pixmap,ctx);
        }
        ctx.restore();

    },
    drawPixmap:function (data,ctx) {
        var img = new Image();

        img.src = data.data;

            ctx.drawImage(img,data.x,data.y,data.w,data.h);
    }
};


//function CreateQt() {
//    this.debugTextArea = document.getElementById("debugTextArea");
//    this.canvas = document.getElementById("canvas");
//    console.log(canvas);
//    this.ctx = canvas.getContext('2d');
//    this.context = this.ctx;
//    this.widgets = {}
//    this.websocket = 1;
//
//    this.debug = function (message) {
//        debugTextArea.value += message + "\n";
//        debugTextArea.scrollTop = debugTextArea.scrollHeight;
//    }
//
//    this.sendMessage = function () {
//        var pseudo = document.getElementById("inputPseudo").value;
//        var msg = document.getElementById("inputText").value;
//        var strToSend = pseudo + ": " + msg;
//        if (websocket != null) {
//            document.getElementById("inputText").value = "";
//            websocket.send(strToSend);
//        }
//    }
//
//    this.initWebsocket = function () {
//        this.wsUri = "ws://localhost:5889";
//        try {
//            if (typeof MozWebSocket == 'function')
//                WebSocket = MozWebSocket;
//
//            this.websocket = new WebSocket(this.wsUri);
//
//            this.websocket.onopen = function (evt) {
//
//                debug("CONNECTED");
//            };
//            this.websocket.onclose = function (evt) {
//                alert('DISCONNECTED');
//                for (var i in evt)
//                    alert(i + ': ' + eval('evt.' + i));
//                debug("DISCONNECTED");
//            };
//            this.websocket.onmessage = function (evt) {
//
//                debug(evt.data);
//            };
//            this.websocket.onerror = function (evt) {
//                debug('ERROR: ');
//                debug(evt.data);
//            };
//            this.websocket.send(sessionID);
//
//        } catch (exception) {
//            debug('ERROR: ' + exception);
//        }
//    }
//
//    this.stopWebsocket = function () {
//        if (websocket)
//            websocket.close();
//    }
//
//    this.checkSocket = function () {
//        if (websocket != null) {
//            var stateStr;
//            switch (websocket.readyState) {
//                case 0:
//                    stateStr = "CONNECTING";
//                    break;
//                case 1:
//                    stateStr = "OPEN";
//                    break;
//                case 2:
//                    stateStr = "CLOSING";
//                    break;
//                case 3:
//                    stateStr = "CLOSED";
//                    break;
//                default:
//                    stateStr = "UNKNOW";
//                    break;
//            }
//            debug("Websocket state = " + websocket.readyState + " ( " + stateStr + " )");
//        } else {
//            debug("Websocket is null");
//        }
//    }
//
//    this.drawEllipse = function (centerX, centerY, width, height) {
//        context.save();
//        context.beginPath();
//        context.moveTo(centerX, centerY - height / 2); // A1
//        context.bezierCurveTo(
//                centerX + width / 2, centerY - height / 2, // C1
//                centerX + width / 2, centerY + height / 2, // C2
//                centerX, centerY + height / 2); // A2
//
//        context.bezierCurveTo(
//                centerX - width / 2, centerY + height / 2, // C3
//                centerX - width / 2, centerY - height / 2, // C4
//                centerX, centerY - height / 2); // A1
//
//        context.fillStyle = "red";
//        context.fill();
//        context.closePath();
//        context.restore();
//    }
//
//    this.Point = function (x, y) {
//        this.x = x;
//        this.y = y;
//    }
//
//    this.drawImage = function (sourcePoint, sourceWidth, sourceHeight, destinationPoint, destinationWidth, destinationHeight, image) {
//        var img = new Image();
//        img.onload = function () {
//            context.drawImage(img, sourcePoint.x, sourcePoint.y, sourceWidth, sourceHeight,
//                    destinationPoint.x, destinationPoint.y, destinationWidth, destinationHeight);
//        }
//        img.src = image;
//    }
//
//    this.drawLine = function (point1, point2) {
//        context.save();
//        context.beginPath();
//        context.moveTo(point1.x, point2.y);
//        context.lineTo(point1.x, point2.y);
//        context.closePath();
//        context.stroke();
//        context.restore();
//    }
//
//    this.drawPath = function (path) {
//
//    }
//
//    this.drawPoint = function (point) {
//        context.fillRect(point.x, point.y, 1, 1);
//        context.fill();
//    }
//
//    this.drawPolygon = function (points) {
//        context.save();
//        context.beginPath();
//        context.moveTo(points[0].x, points[0].y);
//        for (var i = 1; i < array.length; i++) {
//            context.lineTo(array[i].x, array[i].y);
//        }
//        context.fill();
//        context.stroke();
//        context.closePath();
//    }
//
//    this.drawRectangle = function (point, width, height) {
//        context.fillRect(point.x, point.y, width, height);
//        context.strokeRect(point.x, point.y, width, height);
//    }
//
//    this.drawText = function (point, text) {
//        context.fillText(text, point.x, point.y);
//    }
//
//    this.addWidget = function (id, parent, point) {
//        widgets[id] = {
//            'parent':parent,
//            'point':point
//        }
//    }
//
//    this.removeWidget = function (id) {
//        delete widgets[id];
//    }
//}


function init() {
    wsConnector = new WSConnector('ws://localhost:' + portNumber);
    qtLogic = new QtLogic();
    canvasDrawer = new CanvasDrawer('canvas');
    wsConnector.init();
}

$(document).ready(function() {
init();
})

</script>
</head>
<body>
<canvas id="canvas" width="800" height="600">Your browser doesn't support canvas.</canvas>
</body>
</html>
