<html>
<head>
<title>
    Websocket client test
</title>
<style type="text/css">
    .Dialog {
        position: relative;
        background-color: gray;
    }

    .Dialog .Bar {
        position: absolute;
        background-color: #a9a9a9;
    }

    .Dialog .ui-resizable-handle {
        position: absolute;
    }

    .ui-resizable-n {
        cursor: n-resize;
    }
.ui-resizable-s {
        cursor: s-resize;
    }
.ui-resizable-w {
        cursor: w-resize;
    }
.ui-resizable-e {
        cursor: e-resize;
    }
.ui-resizable-nw {
        cursor: nw-resize;
    }
.ui-resizable-ne {
        cursor: ne-resize;
    }
.ui-resizable-sw {
        cursor: sw-resize;
    }
.ui-resizable-se {
        cursor: se-resize;
    }

.LT, .LB, .RT, .RB {
    width: 9px;
    height: 9px;
}

.LT {
    left: 0;
    top:0;
}
.LB {
    left: 0;
    bottom: 0;
}
    .RT {
        right: 0;
        top:0;
    }
    .RB {
        right: 0;
        bottom: 0;
    }
    canvas {
        position: absolute;
        left: 0;
        right: 0;
    }

    canvas:not([data-name]) {
        display: none;
    }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="http://jqueryjs.googlecode.com/svn-history/r6063/trunk/plugins/simulate/jquery.simulate.js"></script>

<script type="text/javascript" src="http://jedrychowski.org/jquery-ui/js/jquery-ui-1.8.23.custom.min.js"></script>
<style type="text/css" src="http://jedrychowski.org/jquery-ui/css/ui-lightness/jquery-ui-1.8.23.custom.css"></style>

<script type="text/javascript">
var delayCallback = function (num, callback) {
    function finished() {
        num -= 1;
        if (num == 0 && callback) {
            callback();
        }
    }

    return finished;
};

function isEmpty(map) {
    for(var key in map) {
        if (map.hasOwnProperty(key)) {
            return false;
        }
        return true;
    }
}


    Array.prototype.pushFront = function(data) {
  this.reverse();
    this.push(data);
    this.reverse();

};

// Mouse wheel plugin
(function ($) {

    var types = ['DOMMouseScroll', 'mousewheel'];

    if ($.event.fixHooks) {
        for (var i = types.length; i;) {
            $.event.fixHooks[ types[--i] ] = $.event.mouseHooks;
        }
    }

    $.event.special.mousewheel = {
        setup:function () {
            if (this.addEventListener) {
                for (var i = types.length; i;) {
                    this.addEventListener(types[--i], handler, false);
                }
            } else {
                this.onmousewheel = handler;
            }
        },

        teardown:function () {
            if (this.removeEventListener) {
                for (var i = types.length; i;) {
                    this.removeEventListener(types[--i], handler, false);
                }
            } else {
                this.onmousewheel = null;
            }
        }
    };

    $.fn.extend({
        mousewheel:function (fn) {
            return fn ? this.bind("mousewheel", fn) : this.trigger("mousewheel");
        },

        unmousewheel:function (fn) {
            return this.unbind("mousewheel", fn);
        }
    });


    function handler(event) {
        var orgEvent = event || window.event, args = [].slice.call(arguments, 1), delta = 0, returnValue = true, deltaX = 0, deltaY = 0;
        event = $.event.fix(orgEvent);
        event.type = "mousewheel";

        // Old school scrollwheel delta
        if (orgEvent.wheelDelta) {
            delta = orgEvent.wheelDelta / 120;
        }
        if (orgEvent.detail) {
            delta = -orgEvent.detail / 3;
        }

        // New school multidimensional scroll (touchpads) deltas
        deltaY = delta;

        // Gecko
        if (orgEvent.axis !== undefined && orgEvent.axis === orgEvent.HORIZONTAL_AXIS) {
            deltaY = 0;
            deltaX = -1 * delta;
        }

        // Webkit
        if (orgEvent.wheelDeltaY !== undefined) {
            deltaY = orgEvent.wheelDeltaY / 120;
        }
        if (orgEvent.wheelDeltaX !== undefined) {
            deltaX = -1 * orgEvent.wheelDeltaX / 120;
        }

        // Add event and delta to the front of the arguments
        args.unshift(event, delta, deltaX, deltaY);

        return ($.event.dispatch || $.event.handle).apply(this, args);
    }

})(jQuery);

// sylvester.js
eval(function (p, a, c, k, e, r) {
    e = function (c) {
        return(c < a ? '' : e(parseInt(c / a))) + ((c = c % a) > 35 ? String.fromCharCode(c + 29) : c.toString(36))
    };
    if (!''.replace(/^/, String)) {
        while (c--)r[e(c)] = k[c] || e(c);
        k = [function (e) {
            return r[e]
        }];
        e = function () {
            return'\\w+'
        };
        c = 1
    }
    ;
    while (c--)if (k[c])p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]);
    return p
}('9 17={3i:\'0.1.3\',16:1e-6};l v(){}v.23={e:l(i){8(i<1||i>7.4.q)?w:7.4[i-1]},2R:l(){8 7.4.q},1u:l(){8 F.1x(7.2u(7))},24:l(a){9 n=7.4.q;9 V=a.4||a;o(n!=V.q){8 1L}J{o(F.13(7.4[n-1]-V[n-1])>17.16){8 1L}}H(--n);8 2x},1q:l(){8 v.u(7.4)},1b:l(a){9 b=[];7.28(l(x,i){b.19(a(x,i))});8 v.u(b)},28:l(a){9 n=7.4.q,k=n,i;J{i=k-n;a(7.4[i],i+1)}H(--n)},2q:l(){9 r=7.1u();o(r===0){8 7.1q()}8 7.1b(l(x){8 x/r})},1C:l(a){9 V=a.4||a;9 n=7.4.q,k=n,i;o(n!=V.q){8 w}9 b=0,1D=0,1F=0;7.28(l(x,i){b+=x*V[i-1];1D+=x*x;1F+=V[i-1]*V[i-1]});1D=F.1x(1D);1F=F.1x(1F);o(1D*1F===0){8 w}9 c=b/(1D*1F);o(c<-1){c=-1}o(c>1){c=1}8 F.37(c)},1m:l(a){9 b=7.1C(a);8(b===w)?w:(b<=17.16)},34:l(a){9 b=7.1C(a);8(b===w)?w:(F.13(b-F.1A)<=17.16)},2k:l(a){9 b=7.2u(a);8(b===w)?w:(F.13(b)<=17.16)},2j:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x+V[i-1]})},2C:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x-V[i-1]})},22:l(k){8 7.1b(l(x){8 x*k})},x:l(k){8 7.22(k)},2u:l(a){9 V=a.4||a;9 i,2g=0,n=7.4.q;o(n!=V.q){8 w}J{2g+=7.4[n-1]*V[n-1]}H(--n);8 2g},2f:l(a){9 B=a.4||a;o(7.4.q!=3||B.q!=3){8 w}9 A=7.4;8 v.u([(A[1]*B[2])-(A[2]*B[1]),(A[2]*B[0])-(A[0]*B[2]),(A[0]*B[1])-(A[1]*B[0])])},2A:l(){9 m=0,n=7.4.q,k=n,i;J{i=k-n;o(F.13(7.4[i])>F.13(m)){m=7.4[i]}}H(--n);8 m},2Z:l(x){9 a=w,n=7.4.q,k=n,i;J{i=k-n;o(a===w&&7.4[i]==x){a=i+1}}H(--n);8 a},3g:l(){8 S.2X(7.4)},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(y){8(F.13(y-x)<=17.16)?x:y})},1o:l(a){o(a.K){8 a.1o(7)}9 V=a.4||a;o(V.q!=7.4.q){8 w}9 b=0,2b;7.28(l(x,i){2b=x-V[i-1];b+=2b*2b});8 F.1x(b)},3a:l(a){8 a.1h(7)},2T:l(a){8 a.1h(7)},1V:l(t,a){9 V,R,x,y,z;2S(7.4.q){27 2:V=a.4||a;o(V.q!=2){8 w}R=S.1R(t).4;x=7.4[0]-V[0];y=7.4[1]-V[1];8 v.u([V[0]+R[0][0]*x+R[0][1]*y,V[1]+R[1][0]*x+R[1][1]*y]);1I;27 3:o(!a.U){8 w}9 C=a.1r(7).4;R=S.1R(t,a.U).4;x=7.4[0]-C[0];y=7.4[1]-C[1];z=7.4[2]-C[2];8 v.u([C[0]+R[0][0]*x+R[0][1]*y+R[0][2]*z,C[1]+R[1][0]*x+R[1][1]*y+R[1][2]*z,C[2]+R[2][0]*x+R[2][1]*y+R[2][2]*z]);1I;2P:8 w}},1t:l(a){o(a.K){9 P=7.4.2O();9 C=a.1r(P).4;8 v.u([C[0]+(C[0]-P[0]),C[1]+(C[1]-P[1]),C[2]+(C[2]-(P[2]||0))])}1d{9 Q=a.4||a;o(7.4.q!=Q.q){8 w}8 7.1b(l(x,i){8 Q[i-1]+(Q[i-1]-x)})}},1N:l(){9 V=7.1q();2S(V.4.q){27 3:1I;27 2:V.4.19(0);1I;2P:8 w}8 V},2n:l(){8\'[\'+7.4.2K(\', \')+\']\'},26:l(a){7.4=(a.4||a).2O();8 7}};v.u=l(a){9 V=25 v();8 V.26(a)};v.i=v.u([1,0,0]);v.j=v.u([0,1,0]);v.k=v.u([0,0,1]);v.2J=l(n){9 a=[];J{a.19(F.2F())}H(--n);8 v.u(a)};v.1j=l(n){9 a=[];J{a.19(0)}H(--n);8 v.u(a)};l S(){}S.23={e:l(i,j){o(i<1||i>7.4.q||j<1||j>7.4[0].q){8 w}8 7.4[i-1][j-1]},33:l(i){o(i>7.4.q){8 w}8 v.u(7.4[i-1])},2E:l(j){o(j>7.4[0].q){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][j-1])}H(--n);8 v.u(a)},2R:l(){8{2D:7.4.q,1p:7.4[0].q}},2D:l(){8 7.4.q},1p:l(){8 7.4[0].q},24:l(a){9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}o(7.4.q!=M.q||7.4[0].q!=M[0].q){8 1L}9 b=7.4.q,15=b,i,G,10=7.4[0].q,j;J{i=15-b;G=10;J{j=10-G;o(F.13(7.4[i][j]-M[i][j])>17.16){8 1L}}H(--G)}H(--b);8 2x},1q:l(){8 S.u(7.4)},1b:l(a){9 b=[],12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;b[i]=[];J{j=10-G;b[i][j]=a(7.4[i][j],i+1,j+1)}H(--G)}H(--12);8 S.u(b)},2i:l(a){9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}8(7.4.q==M.q&&7.4[0].q==M[0].q)},2j:l(a){9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x+M[i-1][j-1]})},2C:l(a){9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x-M[i-1][j-1]})},2B:l(a){9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}8(7.4[0].q==M.q)},22:l(a){o(!a.4){8 7.1b(l(x){8 x*a})}9 b=a.1u?2x:1L;9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}o(!7.2B(M)){8 w}9 d=7.4.q,15=d,i,G,10=M[0].q,j;9 e=7.4[0].q,4=[],21,20,c;J{i=15-d;4[i]=[];G=10;J{j=10-G;21=0;20=e;J{c=e-20;21+=7.4[i][c]*M[c][j]}H(--20);4[i][j]=21}H(--G)}H(--d);9 M=S.u(4);8 b?M.2E(1):M},x:l(a){8 7.22(a)},32:l(a,b,c,d){9 e=[],12=c,i,G,j;9 f=7.4.q,1p=7.4[0].q;J{i=c-12;e[i]=[];G=d;J{j=d-G;e[i][j]=7.4[(a+i-1)%f][(b+j-1)%1p]}H(--G)}H(--12);8 S.u(e)},31:l(){9 a=7.4.q,1p=7.4[0].q;9 b=[],12=1p,i,G,j;J{i=1p-12;b[i]=[];G=a;J{j=a-G;b[i][j]=7.4[j][i]}H(--G)}H(--12);8 S.u(b)},1y:l(){8(7.4.q==7.4[0].q)},2A:l(){9 m=0,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(F.13(7.4[i][j])>F.13(m)){m=7.4[i][j]}}H(--G)}H(--12);8 m},2Z:l(x){9 a=w,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(7.4[i][j]==x){8{i:i+1,j:j+1}}}H(--G)}H(--12);8 w},30:l(){o(!7.1y){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][i])}H(--n);8 v.u(a)},1K:l(){9 M=7.1q(),1c;9 n=7.4.q,k=n,i,1s,1n=7.4[0].q,p;J{i=k-n;o(M.4[i][i]==0){2e(j=i+1;j<k;j++){o(M.4[j][i]!=0){1c=[];1s=1n;J{p=1n-1s;1c.19(M.4[i][p]+M.4[j][p])}H(--1s);M.4[i]=1c;1I}}}o(M.4[i][i]!=0){2e(j=i+1;j<k;j++){9 a=M.4[j][i]/M.4[i][i];1c=[];1s=1n;J{p=1n-1s;1c.19(p<=i?0:M.4[j][p]-M.4[i][p]*a)}H(--1s);M.4[j]=1c}}}H(--n);8 M},3h:l(){8 7.1K()},2z:l(){o(!7.1y()){8 w}9 M=7.1K();9 a=M.4[0][0],n=M.4.q-1,k=n,i;J{i=k-n+1;a=a*M.4[i][i]}H(--n);8 a},3f:l(){8 7.2z()},2y:l(){8(7.1y()&&7.2z()===0)},2Y:l(){o(!7.1y()){8 w}9 a=7.4[0][0],n=7.4.q-1,k=n,i;J{i=k-n+1;a+=7.4[i][i]}H(--n);8 a},3e:l(){8 7.2Y()},1Y:l(){9 M=7.1K(),1Y=0;9 a=7.4.q,15=a,i,G,10=7.4[0].q,j;J{i=15-a;G=10;J{j=10-G;o(F.13(M.4[i][j])>17.16){1Y++;1I}}H(--G)}H(--a);8 1Y},3d:l(){8 7.1Y()},2W:l(a){9 M=a.4||a;o(1g(M[0][0])==\'1f\'){M=S.u(M).4}9 T=7.1q(),1p=T.4[0].q;9 b=T.4.q,15=b,i,G,10=M[0].q,j;o(b!=M.q){8 w}J{i=15-b;G=10;J{j=10-G;T.4[i][1p+j]=M[i][j]}H(--G)}H(--b);8 T},2w:l(){o(!7.1y()||7.2y()){8 w}9 a=7.4.q,15=a,i,j;9 M=7.2W(S.I(a)).1K();9 b,1n=M.4[0].q,p,1c,2v;9 c=[],2c;J{i=a-1;1c=[];b=1n;c[i]=[];2v=M.4[i][i];J{p=1n-b;2c=M.4[i][p]/2v;1c.19(2c);o(p>=15){c[i].19(2c)}}H(--b);M.4[i]=1c;2e(j=0;j<i;j++){1c=[];b=1n;J{p=1n-b;1c.19(M.4[j][p]-M.4[i][p]*M.4[j][i])}H(--b);M.4[j]=1c}}H(--a);8 S.u(c)},3c:l(){8 7.2w()},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(p){8(F.13(p-x)<=17.16)?x:p})},2n:l(){9 a=[];9 n=7.4.q,k=n,i;J{i=k-n;a.19(v.u(7.4[i]).2n())}H(--n);8 a.2K(\'\\n\')},26:l(a){9 i,4=a.4||a;o(1g(4[0][0])!=\'1f\'){9 b=4.q,15=b,G,10,j;7.4=[];J{i=15-b;G=4[i].q;10=G;7.4[i]=[];J{j=10-G;7.4[i][j]=4[i][j]}H(--G)}H(--b);8 7}9 n=4.q,k=n;7.4=[];J{i=k-n;7.4.19([4[i]])}H(--n);8 7}};S.u=l(a){9 M=25 S();8 M.26(a)};S.I=l(n){9 a=[],k=n,i,G,j;J{i=k-n;a[i]=[];G=k;J{j=k-G;a[i][j]=(i==j)?1:0}H(--G)}H(--n);8 S.u(a)};S.2X=l(a){9 n=a.q,k=n,i;9 M=S.I(n);J{i=k-n;M.4[i][i]=a[i]}H(--n);8 M};S.1R=l(b,a){o(!a){8 S.u([[F.1H(b),-F.1G(b)],[F.1G(b),F.1H(b)]])}9 d=a.1q();o(d.4.q!=3){8 w}9 e=d.1u();9 x=d.4[0]/e,y=d.4[1]/e,z=d.4[2]/e;9 s=F.1G(b),c=F.1H(b),t=1-c;8 S.u([[t*x*x+c,t*x*y-s*z,t*x*z+s*y],[t*x*y+s*z,t*y*y+c,t*y*z-s*x],[t*x*z-s*y,t*y*z+s*x,t*z*z+c]])};S.3b=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[1,0,0],[0,c,-s],[0,s,c]])};S.39=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,0,s],[0,1,0],[-s,0,c]])};S.38=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,-s,0],[s,c,0],[0,0,1]])};S.2J=l(n,m){8 S.1j(n,m).1b(l(){8 F.2F()})};S.1j=l(n,m){9 a=[],12=n,i,G,j;J{i=n-12;a[i]=[];G=m;J{j=m-G;a[i][j]=0}H(--G)}H(--12);8 S.u(a)};l 14(){}14.23={24:l(a){8(7.1m(a)&&7.1h(a.K))},1q:l(){8 14.u(7.K,7.U)},2U:l(a){9 V=a.4||a;8 14.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.U)},1m:l(a){o(a.W){8 a.1m(7)}9 b=7.U.1C(a.U);8(F.13(b)<=17.16||F.13(b-F.1A)<=17.16)},1o:l(a){o(a.W){8 a.1o(7)}o(a.U){o(7.1m(a)){8 7.1o(a.K)}9 N=7.U.2f(a.U).2q().4;9 A=7.K.4,B=a.K.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,D=7.U.4;9 b=P[0]-A[0],2a=P[1]-A[1],29=(P[2]||0)-A[2];9 c=F.1x(b*b+2a*2a+29*29);o(c===0)8 0;9 d=(b*D[0]+2a*D[1]+29*D[2])/c;9 e=1-d*d;8 F.13(c*F.1x(e<0?0:e))}},1h:l(a){9 b=7.1o(a);8(b!==w&&b<=17.16)},2T:l(a){8 a.1h(7)},1v:l(a){o(a.W){8 a.1v(7)}8(!7.1m(a)&&7.1o(a)<=17.16)},1U:l(a){o(a.W){8 a.1U(7)}o(!7.1v(a)){8 w}9 P=7.K.4,X=7.U.4,Q=a.K.4,Y=a.U.4;9 b=X[0],1z=X[1],1B=X[2],1T=Y[0],1S=Y[1],1M=Y[2];9 c=P[0]-Q[0],2s=P[1]-Q[1],2r=P[2]-Q[2];9 d=-b*c-1z*2s-1B*2r;9 e=1T*c+1S*2s+1M*2r;9 f=b*b+1z*1z+1B*1B;9 g=1T*1T+1S*1S+1M*1M;9 h=b*1T+1z*1S+1B*1M;9 k=(d*g/f+h*e)/(g-h*h);8 v.u([P[0]+k*b,P[1]+k*1z,P[2]+k*1B])},1r:l(a){o(a.U){o(7.1v(a)){8 7.1U(a)}o(7.1m(a)){8 w}9 D=7.U.4,E=a.U.4;9 b=D[0],1l=D[1],1k=D[2],1P=E[0],1O=E[1],1Q=E[2];9 x=(1k*1P-b*1Q),y=(b*1O-1l*1P),z=(1l*1Q-1k*1O);9 N=v.u([x*1Q-y*1O,y*1P-z*1Q,z*1O-x*1P]);9 P=11.u(a.K,N);8 P.1U(7)}1d{9 P=a.4||a;o(7.1h(P)){8 v.u(P)}9 A=7.K.4,D=7.U.4;9 b=D[0],1l=D[1],1k=D[2],1w=A[0],18=A[1],1a=A[2];9 x=b*(P[1]-18)-1l*(P[0]-1w),y=1l*((P[2]||0)-1a)-1k*(P[1]-18),z=1k*(P[0]-1w)-b*((P[2]||0)-1a);9 V=v.u([1l*x-1k*z,1k*y-b*x,b*z-1l*y]);9 k=7.1o(P)/V.1u();8 v.u([P[0]+V.4[0]*k,P[1]+V.4[1]*k,(P[2]||0)+V.4[2]*k])}},1V:l(t,a){o(1g(a.U)==\'1f\'){a=14.u(a.1N(),v.k)}9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,D=7.U.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 14.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*D[0]+R[0][1]*D[1]+R[0][2]*D[2],R[1][0]*D[0]+R[1][1]*D[1]+R[1][2]*D[2],R[2][0]*D[0]+R[2][1]*D[1]+R[2][2]*D[2]])},1t:l(a){o(a.W){9 A=7.K.4,D=7.U.4;9 b=A[0],18=A[1],1a=A[2],2N=D[0],1l=D[1],1k=D[2];9 c=7.K.1t(a).4;9 d=b+2N,2h=18+1l,2o=1a+1k;9 Q=a.1r([d,2h,2o]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2h)-c[1],Q[2]+(Q[2]-2o)-c[2]];8 14.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 14.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.U)}},1Z:l(a,b){a=v.u(a);b=v.u(b);o(a.4.q==2){a.4.19(0)}o(b.4.q==2){b.4.19(0)}o(a.4.q>3||b.4.q>3){8 w}9 c=b.1u();o(c===0){8 w}7.K=a;7.U=v.u([b.4[0]/c,b.4[1]/c,b.4[2]/c]);8 7}};14.u=l(a,b){9 L=25 14();8 L.1Z(a,b)};14.X=14.u(v.1j(3),v.i);14.Y=14.u(v.1j(3),v.j);14.Z=14.u(v.1j(3),v.k);l 11(){}11.23={24:l(a){8(7.1h(a.K)&&7.1m(a))},1q:l(){8 11.u(7.K,7.W)},2U:l(a){9 V=a.4||a;8 11.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.W)},1m:l(a){9 b;o(a.W){b=7.W.1C(a.W);8(F.13(b)<=17.16||F.13(F.1A-b)<=17.16)}1d o(a.U){8 7.W.2k(a.U)}8 w},2k:l(a){9 b=7.W.1C(a.W);8(F.13(F.1A/2-b)<=17.16)},1o:l(a){o(7.1v(a)||7.1h(a)){8 0}o(a.K){9 A=7.K.4,B=a.K.4,N=7.W.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;8 F.13((A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2])}},1h:l(a){o(a.W){8 w}o(a.U){8(7.1h(a.K)&&7.1h(a.K.2j(a.U)))}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=F.13(N[0]*(A[0]-P[0])+N[1]*(A[1]-P[1])+N[2]*(A[2]-(P[2]||0)));8(b<=17.16)}},1v:l(a){o(1g(a.U)==\'1f\'&&1g(a.W)==\'1f\'){8 w}8!7.1m(a)},1U:l(a){o(!7.1v(a)){8 w}o(a.U){9 A=a.K.4,D=a.U.4,P=7.K.4,N=7.W.4;9 b=(N[0]*(P[0]-A[0])+N[1]*(P[1]-A[1])+N[2]*(P[2]-A[2]))/(N[0]*D[0]+N[1]*D[1]+N[2]*D[2]);8 v.u([A[0]+D[0]*b,A[1]+D[1]*b,A[2]+D[2]*b])}1d o(a.W){9 c=7.W.2f(a.W).2q();9 N=7.W.4,A=7.K.4,O=a.W.4,B=a.K.4;9 d=S.1j(2,2),i=0;H(d.2y()){i++;d=S.u([[N[i%3],N[(i+1)%3]],[O[i%3],O[(i+1)%3]]])}9 e=d.2w().4;9 x=N[0]*A[0]+N[1]*A[1]+N[2]*A[2];9 y=O[0]*B[0]+O[1]*B[1]+O[2]*B[2];9 f=[e[0][0]*x+e[0][1]*y,e[1][0]*x+e[1][1]*y];9 g=[];2e(9 j=1;j<=3;j++){g.19((i==j)?0:f[(j+(5-i)%3)%3])}8 14.u(g,c)}},1r:l(a){9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=(A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2];8 v.u([P[0]+N[0]*b,P[1]+N[1]*b,(P[2]||0)+N[2]*b])},1V:l(t,a){9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,N=7.W.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 11.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*N[0]+R[0][1]*N[1]+R[0][2]*N[2],R[1][0]*N[0]+R[1][1]*N[1]+R[1][2]*N[2],R[2][0]*N[0]+R[2][1]*N[1]+R[2][2]*N[2]])},1t:l(a){o(a.W){9 A=7.K.4,N=7.W.4;9 b=A[0],18=A[1],1a=A[2],2M=N[0],2L=N[1],2Q=N[2];9 c=7.K.1t(a).4;9 d=b+2M,2p=18+2L,2m=1a+2Q;9 Q=a.1r([d,2p,2m]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2p)-c[1],Q[2]+(Q[2]-2m)-c[2]];8 11.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 11.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.W)}},1Z:l(a,b,c){a=v.u(a);a=a.1N();o(a===w){8 w}b=v.u(b);b=b.1N();o(b===w){8 w}o(1g(c)==\'1f\'){c=w}1d{c=v.u(c);c=c.1N();o(c===w){8 w}}9 d=a.4[0],18=a.4[1],1a=a.4[2];9 e=b.4[0],1W=b.4[1],1X=b.4[2];9 f,1i;o(c!==w){9 g=c.4[0],2l=c.4[1],2t=c.4[2];f=v.u([(1W-18)*(2t-1a)-(1X-1a)*(2l-18),(1X-1a)*(g-d)-(e-d)*(2t-1a),(e-d)*(2l-18)-(1W-18)*(g-d)]);1i=f.1u();o(1i===0){8 w}f=v.u([f.4[0]/1i,f.4[1]/1i,f.4[2]/1i])}1d{1i=F.1x(e*e+1W*1W+1X*1X);o(1i===0){8 w}f=v.u([b.4[0]/1i,b.4[1]/1i,b.4[2]/1i])}7.K=a;7.W=f;8 7}};11.u=l(a,b,c){9 P=25 11();8 P.1Z(a,b,c)};11.2I=11.u(v.1j(3),v.k);11.2H=11.u(v.1j(3),v.i);11.2G=11.u(v.1j(3),v.j);11.36=11.2I;11.35=11.2H;11.3j=11.2G;9 $V=v.u;9 $M=S.u;9 $L=14.u;9 $P=11.u;', 62, 206, '||||elements|||this|return|var||||||||||||function|||if||length||||create|Vector|null|||||||||Math|nj|while||do|anchor||||||||Matrix||direction||normal||||kj|Plane|ni|abs|Line|ki|precision|Sylvester|A2|push|A3|map|els|else||undefined|typeof|contains|mod|Zero|D3|D2|isParallelTo|kp|distanceFrom|cols|dup|pointClosestTo|np|reflectionIn|modulus|intersects|A1|sqrt|isSquare|X2|PI|X3|angleFrom|mod1|C2|mod2|sin|cos|break|C3|toRightTriangular|false|Y3|to3D|E2|E1|E3|Rotation|Y2|Y1|intersectionWith|rotate|v12|v13|rank|setVectors|nc|sum|multiply|prototype|eql|new|setElements|case|each|PA3|PA2|part|new_element|round|for|cross|product|AD2|isSameSizeAs|add|isPerpendicularTo|v22|AN3|inspect|AD3|AN2|toUnitVector|PsubQ3|PsubQ2|v23|dot|divisor|inverse|true|isSingular|determinant|max|canMultiplyFromLeft|subtract|rows|col|random|ZX|YZ|XY|Random|join|N2|N1|D1|slice|default|N3|dimensions|switch|liesIn|translate|snapTo|augment|Diagonal|trace|indexOf|diagonal|transpose|minor|row|isAntiparallelTo|ZY|YX|acos|RotationZ|RotationY|liesOn|RotationX|inv|rk|tr|det|toDiagonalMatrix|toUpperTriangular|version|XZ'.split('|'), 0, {}))

Matrix.prototype.toTransformMatrix = function () {
    return [this.e(1, 1), this.e(1, 2), this.e(2, 1), this.e(2, 2), this.e(3, 1), this.e(3, 2)];
};

function debug(msg) {
    if (console)
        console.log(msg);
}

var sessionID = '[PUT_SESSION_ID_HERE]';
var portNumber = [PUT_PORT_NUMBER_HERE];
var verbose = false;

var widgetsContainer = $('#widgets');

function WSConnector(uri, options) {
    this.wsUri = uri;
    this.options = options;
}

WSConnector.prototype = {
    init:function () {
        var self = this;
        try {
            if (typeof MozWebSocket == 'function')
                WebSocket = MozWebSocket;
            this.websocket = new WebSocket(this.wsUri);
            socket = this.websocket;
            this.websocket.onopen = function () {
                debug('Connected');
            };
            this.websocket.onmessage = function (evt) {
                //$('.data').html(evt.data);
                try {
                    var data = jQuery.parseJSON(evt.data);
                } catch (e) {
                    console.log(evt.data);
                }
                if (verbose)
                    debug(data);
                qtLogic.input(data);

            };
            this.websocket.onerror = function (evt) {
                debug('Error');
                debug(evt);
            };
            this.websocket.onclose = function (evt) {
                debug('Connection closed.');
            };
        } catch (exception) {
            debug('ERROR: ' + exception);
        }

    },
    helloMessage:function () {
        this.websocket.send(sessionID);
    },
    sendEvent:function (event) {
        this.websocket.send(JSON.stringify(event));
    }
};

function QtLogic(container) {
    this.container = container;
    this.widgets = {}
    this.bindGlobalEvents();
}

QtLogic.prototype = {
    /*
     Collect all images information and preload them.
     Affected by issue: http://stackoverflow.com/questions/4776670/should-setting-an-image-src-to-data-url-be-available-immediately
     */
    loadImages:function (data, callback) {
        var images_data = [];
        $.each(data, function (_, d) {
            if (d.command == 'draw') {
                $.each(d.render, function (_, r) {
                    if (r.t == 'image') {
                        images_data.push(r.data);
                    }
                });
            }
        });
        var delayer = delayCallback(images_data.length, callback);
        $.each(images_data, function (_, img) {
            var image = new Image();
            image.src = img;
            image.onload = delayer;
        });
    },
    input:function (data) {
        var self = this;
        var afterLoad = function () {
            $.each(data, function (_, value) {
                self.singleInput(value);
            });
        };
        this.loadImages(data, afterLoad);
    },
    singleInput:function (data) {
        var self = this;
        switch (data.command) {
            case "draw":
                this.drawCommand(data);
                break;
            case "addChild":
                this.addChildCommand(data);
                break;
            case "show":
                this.showElement(data);
                break;
            case "resize":
                this.resizeCommand(data);
                break;
            case "hide":
                this.hideElement(data);
                break;
            default:
                debug(data);
        }
    },
    addChildCommand:function (data) {
        this.addWidgetChild(data.id, data.child, data.flags);
    },
    removeChildCommand:function (data) {
        console.log(data);
    },
    showElement:function (data) {
        var canvas = this.widgets[data.id].canvas;
        canvas.show();
        if(canvas.hasClass("DialogCanvas")) {
            canvas.parent().show();
        }
    },
    hideElement:function (data) {
        var canvas = this.widgets[data.id].canvas;
        canvas.hide();
        if(canvas.hasClass("DialogCanvas")) {
            canvas.parent().hide();
        }

    },
    resizeCommand:function (data) {
        var canvasElement = this.widgets[data.id].canvas;
        canvasElement.attr('height', data.new.h);
        canvasElement.attr('width', data.new.w);
    },
    drawCommand:function (data) {
        widgety = this.widgets;
        var widgetData = data.widget;
        var region = widgetData.r;
        var widgetId = widgetData.id;
        this.updateWidget(widgetId, { // store
            w:widgetData.w,
            h:widgetData.h,
            x:widgetData.x,
            y:widgetData.y,
            name:widgetData.name
        });
        var widget = this.getWidget(widgetId);
        current_widget = widget;
        var renders = data.render;
        var translation = this.calculateTranslation(widget);
        widget.canvas.css({left:translation.x, top:translation.y});
        var canvasDrawer = widget.canvasDrawer;
        canvasDrawer.ctx.save();

        canvasDrawer.setup(region, translation);
        //canvasDrawer.setupBrush({style: 0}); // Clear brush
        //canvasDrawer.setupPen('none'); // Clear brush
        $.each(renders, function (_, value) {
            canvasDrawer.draw(value, translation);
        });
        canvasDrawer.ctx.restore();

    },
    getWidget:function (id) {
        if (!this.widgets[id]) {
            this.widgets[id] = {
                id:id,
                parent:null,
                children:[]
            };
            var widget = this.widgets[id];
            widget.canvas = $('<canvas></canvas>')
                    .data('widget', widget)
                    .appendTo($('#widgets'));
            widget.canvasDrawer = new CanvasDrawer(widget.canvas);
        }
        return this.widgets[id];
    },
    updateWidget:function (id, data) {
        var WINDOW_LT = {x: 5, y: 20};
        var WINDOW_RB= {x: 5, y: 5 }

        var widget = this.getWidget(id);
        $.extend(widget, data);
        var canvasElement = widget.canvas;
        if (canvasElement) {
            canvasElement.attr('data-name', data.name);
            if (canvasElement.attr('height') != data.h)
                canvasElement.attr('height', data.h);
            if (canvasElement.attr('width') != data.w)
                canvasElement.attr('width', data.w);
            canvasElement.css({
                left:data.x,
                top:data.y
            });
            if(canvasElement.hasClass("DialogCanvas") ) {
                //canvasElement.css({left:0, top:0});
                widget.x = WINDOW_LT.x;
                widget.y = WINDOW_LT.y;
            }
            if(canvasElement.hasClass("DialogCanvas") && data.x && data.y && data.w && data.h && ! canvasElement.hasClass("Set")) {
                canvasElement
                        .css({left:0, top:0})
                        .addClass("Set");
                var parents_dialog = canvasElement.parents(".Dialog");
                parents_dialog
                        .css({left: data.x, top: data.y, width: data.w + WINDOW_LT.x + WINDOW_RB.x, height: data.h + WINDOW_LT.y + WINDOW_RB.y})
                        .draggable({
                            handle: '.Bar'
                        })
                        .resizable({
                            handles: {
                                w: '.Left',
                                e: '.Right',
                                s: '.Bottom',
                                nw: '.LT',
                                ne: '.RT',
                                sw: '.LB',
                                se: '.RB'
                            },
                            stop: function(e, ui) {
                                var new_width =  ui.size.width - WINDOW_LT.x - WINDOW_RB.x,
                                        new_height = ui.size.height - WINDOW_LT.y - WINDOW_RB.y;
                                console.log(data);
                                 console.log('New size: ' + new_width + 'x' + new_height);
                                 return false;
                            },
                            ghost: true
                        });
                parents_dialog.find(".Bar")
                        .css({width: data.w + WINDOW_LT.x + WINDOW_RB.x, height: WINDOW_LT.y});
                parents_dialog.find(".Left")
                        .css({width: WINDOW_LT.x, height: data.h, left: 0, top: WINDOW_LT.y});
                parents_dialog.find(".Right")
                        .css({width: WINDOW_RB.x, height: data.h, right: 0, top: WINDOW_LT.y});
                parents_dialog.find(".Bottom")
                        .css({width: data.w, height: WINDOW_RB.y, left: WINDOW_LT.x, bottom: 0});
                widget.x = WINDOW_LT.x;
                widget.y = WINDOW_LT.y;
            }
        } else {
        }
    },
    addWidgetChild:function (id, childId, flags) {
        var widget = this.getWidget(id);
        var children = widget.children;
        var found = false;
        $.each(children, function (_, child) {
            if (child.id == childId) {
                found = true;
                return false; // break
            }
        });
        if (!found) {
            var newChildWidget = this.getWidget(childId);
            if(flags & 3) {
               var container = $('<div class="Dialog"><div class="Bar"></div><div class="Left ui-resizable-handle ui-resizable-w"></div><div class="Bottom ui-resizable-handle ui-resizable-s"></div><div class="Right ui-resizable-handle ui-resizable-e"></div><div class="LT ui-resizable-handle ui-resizable-nw"></div><div class="LB ui-resizable-handle ui-resizable-sw"></div><div class="RT ui-resizable-handle ui-resizable-ne"></div><div class="RB ui-resizable-handle ui-resizable-se"></div></div>')
                       .appendTo($('#widgets'));
                newChildWidget.canvas
                        .addClass("DialogCanvas")
                        .detach().appendTo(container);
            } else {
                newChildWidget.canvas.detach().insertAfter(widget.canvas);
            }
            children.push(newChildWidget);
            this.updateWidget(childId, {parent:this.getWidget(id)});
        }
    },
    calculateTranslation:function (widget) {
        var x = 0, y = 0;
        var parent = widget;
        while (parent) {
            x += parent.x;
            y += parent.y;
            parent = parent.parent;
        }
        return {x:x, y:y};
    },
    bindGlobalEvents:function () {
        this.enterQue = [];
        
        this.container
                .on('mouseenter', 'canvas', function (evt) {
                    var widget = $(this).data('widget');
                    var parent = widget.parent;
                    var array = [widget];
                    while(parent) {
                        array.pushFront(parent);
                        parent = parent.parent;
                    }
                    this.enterQue = array;
                    var len =  array.length;
                    for(var i = 0; i < len; i++) {
                        for(var j = 0; j <= i; j++)  {
                        widget = array[j];
                        var eventData = parseMouseEvent(evt,widget.canvas);
                        wsConnector.sendEvent({
                            command:"mouse",
                            type:"enter",
                            id:widget.id,
                            x:eventData.x,
                            y:eventData.y
                        });
                        widget.mousePositionX = eventData.x;
                        widget.mousePositionY = eventData.y;
                        }
                    }
                })
                .on('mouseleave', 'canvas', function (evt) {
                    var widget = $(this).data('widget');
                    var parent = widget.parent;
                    var array = [widget];
                    while(parent) {
                        array.pushFront(parent);
                        parent = parent.parent;
                    }
                    this.enterQue = array;
                    var len =  array.length;
                    for(var i = 0; i < len; i++) {
                        for(var j = 0; j <= i; j++)  {
                            widget = array[j];
                            var eventData = parseMouseEvent(evt,widget.canvas);
                            wsConnector.sendEvent({
                                command:"mouse",
                                type:"leave",
                                id:widget.id,
                                x:eventData.x,
                                y:eventData.y
                            });
                            widget.mousePositionX = undefined;
                            widget.mousePositionY = undefined;
                        }
                    }
                })
                .on('mousedown', 'canvas', function (evt) {
                    var widget = $(this).data('widget');
                    if (widget) {
                        var eventData = parseMouseEvent(evt);

                        wsConnector.sendEvent({
                            command:"mouse",
                            type:"press",
                            id:widget.id,
                            btn:eventData.button,
                            x:eventData.x,
                            y:eventData.y,
                            modifiers:eventData.modifiers
                        });
                    }
                })
                .on('mouseup', 'canvas', function (evt) {
                    var widget = $(this).data('widget');
                    if (widget) {
                        var eventData = parseMouseEvent(evt);

                        wsConnector.sendEvent({
                            command:"mouse",
                            type:"release",
                            id:widget.id,
                            btn:eventData.button,
                            x:eventData.x,
                            y:eventData.y,
                            modifiers:eventData.modifiers
                        });
                    }
                })
                .on('mousewheel', 'canvas', function (evt, delta) {
                    var widget = $(this).data('widget');
                    if (widget) {
                        var eventData = parseMouseEvent(evt);
                        wsConnector.sendEvent({
                            command:"wheel",
                            type:"move",
                            id:widget.id,
                            btn:0,
                            x:eventData.x,
                            y:eventData.y,
                            modifiers:eventData.modifiers,
                            delta:delta,
                            orientation:eventData.orientation
                        });
                    }
                })
                .on('mousemove', 'canvas', function (evt) {
                    var widget = $(this).data('widget');
                    if (widget) {
                        var eventData = parseMouseEvent(evt);

                        wsConnector.sendEvent({
                            command:"mouse",
                            type:"move",
                            id:widget.id,
                            btn:eventData.button,
                            x:eventData.x,
                            ox:eventData.ox,
                            y:eventData.y,
                            oy:eventData.oy,
                            modifiers:eventData.modifiers
                        });

                        widget.mousePositionX = eventData.x;
                        widget.mousePositionY = eventData.y;
                    }
                });
        $(document)
                .keydown(function (evt) {
                    var eventData = parseKeyEvent(evt);
                    wsConnector.sendEvent({
                        command:"key",
                        type:"press",
                        key:eventData.key,
                        text: eventData.text,
                        modifiers:eventData.modifiers,
                        count: 1,
                        "autorep": false
                    });
                })
                .keyup(function (evt) {
                    debug(evt)
                    var eventData = parseKeyEvent(evt);
                    wsConnector.sendEvent({
                        command:"key",
                        type:"release",
                        key:eventData.key,
                        text: eventData.text,
                        modifiers:eventData.modifiers,
                        count: 1,
                        "autorep": false
                    });
                });


    }
};

function parseMouseEvent(evt,widget) {
    var data = {};
    switch (evt.button) {
        case 0: // left
            data.button = 1;
            break;
        case 3: // right
            data.button = 2;
            break;
        case 2: // midle
            data.button = 4;
        default:
            data.button = 0;
    }
    var modifiers = 0;
    if (evt.ctrlKey)
        modifiers += 0x04000000;
    if (evt.shiftKey)
        modifiers += 0x02000000;
    if (evt.altKey)
        modifiers += 0x08000000;
    if (evt.metaKey)
        modifiers += 0x10000000;
    var offset = $(widget || evt.currentTarget).offset();
    data.ox = evt.pageX;
    data.oy = evt.pageY;
    data.x = evt.pageX - offset.left;
    data.y = evt.pageY - offset.top;
    data.modifiers = modifiers;
    data.orientation = 2;

    return data;
}

function parseKeyEvent(evt) {
    var data = {};
    if(evt.keyCode>= 65 && evt.keyCode <=90 ) {
        data.key = evt.keyCode;
        data.text = $.trim(String.fromCharCode(evt.which)).toLowerCase();
    } else {

    }

    var modifiers = 0;
    if (evt.ctrlKey)
        modifiers += 0x04000000;
    if (evt.shiftKey) {
        modifiers += 0x02000000;
        data.text = data.text.toUpperCase();
    }
    if (evt.altKey)
        modifiers += 0x08000000;
    if (evt.metaKey)
        modifiers += 0x10000000;
    data.modifiers = modifiers;

    return data;
}

function CanvasDrawer(canvas) {
    this.canvas = canvas[0];
    this.ctx = this.canvas.getContext("2d");
    this.currentTranslation = {x:0, y:0};
}

CanvasDrawer.prototype = {
    setup:function (region, translation) {
        var r = region;
        //this.ctx.rect(translation.x, translation.y, r.w, r.h);
        //this.ctx.clip();
        //this.ctx.translate(translation.x, translation.y);
    },
    draw:function (data, translation) {
        var ctx = this.ctx;

        switch (data.t) {
            case "image":
                this.drawImage(data);
                break;
            case "rect":
                this.drawRect(data);
                break;
            case "state":
                this.drawState(data);
                break;
            case "tiledPixmap":
                this.drawTtiledPixmap(data);
                break;
            case "text":
                this.drawText(data);
                break;
            case "line":
                this.drawLine(data);
                break;
            case "path":
                this.drawPath(data);
                break;
            case "ellipse":
                this.drawEllipse(data);
                break;
            case "points":
                this.drawPoints(data);
                break;
            case "polygon":
                this.drawPolygon(data);
                break;
            default:
            //debug(data);
        }


    },
    drawImage:function (data) {
        var img = new Image();
        img.src = data.data;
        this.ctx.drawImage(img, data.x, data.y);
    },
    drawRect:function (data) {
        this.ctx.lineWidth = 0.2;
        this.ctx.fillRect(data.x, data.y, data.w, data.h);
        //this.ctx.strokeRect(data.x, data.y, data.w, data.h);
    },
    drawState:function (data) {
        var brush = data.data.brush;
        var bbrush = data.data.bbrush;
        if (bbrush)
            console.log(bbrush);
        var opacity = data.data.opacity;
        if (opacity) console.log('Opacity: ' + opacity);
        var composition = data.data.composition;
        if (composition) console.log('composition: ' + composition);
        var font = data.data.font;
        var pen = data.data.pen;
        var transform = data.data.transform;
        var clip = data.data.clip;
        if (clip)
            this.setupClipping(clip);
        if (transform)
            this.setupTransform(transform);
        if (pen) this.setupPen(pen);
        if (brush) this.setupBrush(brush);
    },
    drawTtiledPixmap:function (data) {

        var img = new Image();
        img.src = data.pixmap;
        var ctx = this.ctx;
        ctx.drawImage(img, data.rect.x, data.rect.y, data.rect.w, data.rect.h);
    },
    drawText:function (data) {
        var ctx = this.ctx;
        var fdata = data.data;
        //ctx.font = fdata.font;
        ctx.font = '9pt Helvetica';
        var fillOld = ctx.strokeStyle;
        ctx.fillStyle = ctx.strokeStyle;
        ctx.fillText(fdata.text, fdata.x, fdata.y);
        ctx.fillStyle = fillOld;
    },
    drawLine:function (data) {
        var ctx = this.ctx;
        ctx.beginPath();
        ctx.moveTo(data.xs, data.ys);
        ctx.lineTo(data.xe, data.ye);
        ctx.stroke();
    },
    drawPath:function (data) {
        var ctx = this.ctx;
        ctx.beginPath();
        $.each(data.data, function (_, v) {
            var type = v.t;
            var points = v.p;
            switch (type) {
                case 0:
                    ctx.moveTo(points[0][0], points[0][1]);
                    break;
                case 1:
                    ctx.lineTo(points[0][0], points[0][1]);
                    break;
                case 2:
                    if (points.lenght == 2) {
                        ctx.quadraticCurveTo(points[0][0], points[0][1], points[1][0], points[1][1]);
                    } else { // 3
                        ctx.bezierCurveTo(points[0][0], points[0][1], points[1][0], points[1][1], points[2][0], points[2][1]);
                    }
            }
        });
        ctx.fill();
        ctx.stroke();
    },
    drawEllipse:function (data) {
        var ctx = this.ctx;
        var x = data.x, y = data.y, w = data.w, h = data.h;
        var kappa = .5522848;
        var ox = (w / 2) * kappa, // control point offset horizontal
                oy = (h / 2) * kappa, // control point offset vertical
                xe = x + w, // x-end
                ye = y + h, // y-end
                xm = x + w / 2, // x-middle
                ym = y + h / 2;       // y-middle
        ctx.beginPath();
        ctx.moveTo(x, ym);
        ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
        ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
        ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
        ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
    },
    drawPoints:function (data) {
        var ctx = this.ctx;
        $.each(data, function (_, d) {
            ctx.strokeRect(d[0], d[1], 1, 1);
        });
    },
    drawPolygon:function (data) {
        var ctx = this.ctx;
        $.each(data.data, function (i, d) {
            if (i == 0) {
                ctx.moveTo(d[0], d[1]);
            } else {
                ctx.lineTo(d[0], d[1]);
            }
        });
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
    },
    setupBrush:function (brush) {
        var ctx = this.ctx;
        switch (brush.style) {
            case 0: // Qt::NoBrush
                ctx.fillStyle = "rgba(0,0,0,0)"; // no filling
                break;
            case 1: // Qt::SolidPattern
                ctx.fillStyle = brush.color;
                break;
            case 15: // Qt::LinearGradientPattern
                var gradient = brush.gradient;
                ctx.fillStyle = CanvasHelper.createGradient(ctx, gradient, 15);
                break;
            default:
                console.log('Unknown style: ' + brush.style);
        }
    },
    setupPen:function (pen) {
        var ctx = this.ctx;
        if (pen.color) {
            ctx.strokeStyle = pen.color;
        }
        if (pen.brush) {
            ctx.strokeStyle = CanvasHelper.createGradient(ctx, pen.brush.gradient, pen.brush.style);
        }
        if (pen.dash && pen.dash.pattern.length != 0) {
            // TODO
        }
        if(pen === "none" || isEmpty(pen)) {
            ctx.strokeStyle = "rgba(0,0,0,0)";
        }
        ctx.lineWidth = pen.width;
        ctx.lineJoin = pen.join;
        ctx.miterLimit = pen.miter;
    },
    setupTransform:function (transform) {
        this.ctx.setTransform(transform[0][0], transform[0][1], transform[1][0], transform[1][1], transform[2][0] + this.currentTranslation.x, transform[2][1] + this.currentTranslation.y);
        //this.ctx.setTransform(transform[0][0], transform[0][1], transform[1][0], transform[1][1], transform[2][0], transform[2][1]);
    },
    setupClipping:function (clip) {
        //TODO
        return;
        var ctx = this.ctx;
        var self = this;
        ctx.save();
        if (!jQuery.isEmptyObject(clip)) {
            ctx.beginPath();
            $.each(clip.data, function (_, v) {
                var type = v.t;
                var points = v.p;
                switch (type) {
                    case 0:
                        ctx.moveTo(points[0][0] + self.currentTranslation.x, points[0][1] + self.currentTranslation.y);
                        break;
                    case 1:
                        ctx.lineTo(points[0][0] + self.currentTranslation.x, points[0][1] + self.currentTranslation.y);
                        break;
                    case 2:
                        if (points.length == 2) {
                            ctx.quadraticCurveTo(points[0][0], points[0][1], points[1][0], points[1][1]);
                        } else { // 3
                            ctx.bezierCurveTo(points[0][0], points[0][1], points[1][0], points[1][1], points[2][0], points[2][1]);
                        }
                }
            });
            ctx.closePath();
            ctx.clip();
        } else {
            ctx.restore();
        }
    }
};

CanvasHelper = function () {
};

CanvasHelper.createGradient = function (ctx, gradient, style) {
    if (style == 15) {
        var lingrad = ctx.createLinearGradient(gradient.xs, gradient.ys, gradient.xe, gradient.ye);
        $.each(gradient.stops, function (_, g) {
            lingrad.addColorStop(g[0], g[1]);
        });
        return lingrad;
    }
};


function init() {
    wsConnector = new WSConnector('ws://' + window.document.location.hostname + ':' + portNumber);
    qtLogic = new QtLogic($('#widgets'));

    wsConnector.init();
}

$(document).ready(function () {
    init();
});

</script>
</head>
<body>
<div id="widgets"></div>
<div class="data"></div>
<input type="text" id="dupa"></input>
</body>
</html>
