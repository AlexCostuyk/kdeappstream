<html>
<head>
<title>
    Websocket client test
</title>
<style type="text/css">
    canvas {
        border: 1px solid black;
    }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">

function debug(msg) {
    if (console)
        console.log(msg);
}

var sessionID = '[PUT_SESSION_ID_HERE]';
var portNumber = [PUT_PORT_NUMBER_HERE];
var verbose = false;

function WSConnector(uri, options) {
    this.wsUri = uri;
    this.options = options;
}

WSConnector.prototype = {
    init:function () {
        var self = this;
        try {
            if (typeof MozWebSocket == 'function')
                WebSocket = MozWebSocket;
            this.websocket = new WebSocket(this.wsUri);
            socket = this.websocket;
            this.websocket.onopen = function () {
                debug('Connected');
            };
            this.websocket.onmessage = function (evt) {
                //$('.data').html(evt.data);
                var data = jQuery.parseJSON(evt.data);
                if (verbose)
                    debug(data);
                qtLogic.input(data);
            };
            this.websocket.onerror = function (evt) {
                debug('Error');
                debug(evt);
            };
            this.websocket.onclose = function (evt) {
                debug('Connection closed.');
            };
        } catch (exception) {
            debug('ERROR: ' + exception);
        }

    },
    helloMessage:function () {
        this.websocket.send(sessionID);
        console.log('sent');
    }
};

function QtLogic() {
    this.widgets = {}
}

QtLogic.prototype = {
    input:function (data) {
        var self = this;
        $.each(data, function (_, value) {
            self.singleInput(value);
        });
    },
    singleInput:function (data) {
        var self = this;
        switch (data.command) {
            case "draw":
                this.drawCommand(data);
                break;
            case "addChild":
                this.addChildCommand(data);
                break;
            default:
                debug(data);
        }
    },
    addChildCommand:function (data) {
        this.addWidgetChild(data.id, data.child);
    },
    resizeCommand:function (data) {
        // TODO
    },
    drawCommand:function (data) {
        widgety = this.widgets;
        var widgetData = data.widget;
        var widgetId = widgetData.id;
        this.updateWidget(widgetId, { // store
            w:widgetData.w,
            h:widgetData.h,
            x:widgetData.x,
            y:widgetData.y,
            name:widgetData.name
        });
        var widget = this.getWidget(widgetId);
        var renders = data.render;
        var translation = this.calculateTranslation(widget);
        $.each(renders, function (_, value) {
            canvasDrawer.draw(value, translation);
        });
    },
    getWidget:function (id) {
        if (!this.widgets[id]) {
            this.widgets[id] = {
                id:id,
                parent:null,
                children:[]
            }
        }
        return this.widgets[id];
    },
    updateWidget:function (id, data) {
        $.extend(this.getWidget(id), data);
    },
    addWidgetChild:function (id, childId) {
        var children = this.getWidget(id).children;
        var found = false;
        $.each(children, function (_, child) {
            if (child.id == childId) {
                found = true;
                return false; // break
            }
        });
        if (!found) {
            children.push(this.getWidget(childId));
            this.updateWidget(childId, {parent:this.getWidget(id)});
        }
    },
    calculateTranslation:function (widget) {
        var x = 0, y = 0;
        var parent = widget;
        while (parent) {
            x += parent.x;
            y += parent.y;
            parent = parent.parent;
        }
        return {x:x, y:y};
    }
};

function CanvasDrawer(canvasId) {
    this.canvas = document.getElementById(canvasId);
    this.ctx = this.canvas.getContext("2d");
}

CanvasDrawer.prototype = {
    draw:function (data, translation) {
        var ctx = this.ctx;
        ctx.translate(translation.x, translation.y);
        switch (data.t) {
            case "pixmap":
                this.drawPixmap(data);
                break;
            case "rect":
                this.drawRect(data);
                break;
            case "state":
                this.drawState(data);
                break;
            case "tiledPixmap":
                this.drawTtiledPixmap(data);
                break;
            case "text":
                this.drawText(data);
                break;
            case "line":
                this.drawLine(data);
                break;
            case "path":
                this.drawPath(data);
                break;
            default:
                debug(data);
        }
        ctx.translate(-translation.x, -translation.y);

    },
    drawPixmap:function (data) {
        var img = new Image();
        img.src = data.data;
        this.ctx.drawImage(img, data.x, data.y, data.w, data.h);
    },
    drawRect:function (data) {
        this.ctx.lineWidth = 0.2;
        this.ctx.fillRect(data.x, data.y, data.w, data.h);
        this.ctx.strokeRect(data.x, data.y, data.w, data.h);
    },
    drawState:function (data) {
        var brush = data.data.brush;
        var font = data.data.font;
        var pen = data.data.pen;
        var transform = data.data.transform;
        if (pen) this.setupPen(pen);
        if (brush) this.setupBrush(brush);
    },
    drawTtiledPixmap:function (data) {
        var img = new Image();
        img.src = data.pixmap;
        var ctx = this.ctx;
        ctx.drawImage(img, data.rect.x, data.rect.y, data.rect.w, data.rect.h);

    },
    drawText:function (data) {
        var ctx = this.ctx;
        var fdata = data.data;
        //ctx.font = fdata.font;
        ctx.font = '9pt Helvetica';
        var fillOld = ctx.strokeStyle;
        ctx.fillStyle = ctx.strokeStyle;
        ctx.fillText(fdata.text, fdata.x, fdata.y);
        ctx.fillStyle = fillOld;
    },
    drawLine:function (data) {
        var ctx = this.ctx;
        ctx.beginPath();
        ctx.moveTo(data.xs, data.ys);
        ctx.lineTo(data.xe, data.ye);
        ctx.stroke();
    },
    drawPath:function (data) {
        var ctx = this.ctx;
        ctx.beginPath();
        $.each(data.data, function (_, v) {
            var type = v.t;
            var points = v.p;
            switch (type) {
                case 0:
                    ctx.moveTo(points[0][0], points[0][1]);
                    break;
                case 1:
                    ctx.lineTo(points[0][0], points[0][1]);
                    break;
                case 2:
                    if (points.lenght == 2) {
                        ctx.quadraticCurveTo(points[0][0], points[0][1], points[1][0], points[1][1]);
                    } else { // 3
                        ctx.bezierCurveTo(points[0][0], points[0][1], points[1][0], points[1][1], points[2][0], points[2][1]);
                    }
            }
        });
        ctx.fill();
        ctx.stroke();
    },
    setupBrush:function (brush) {
        var ctx = this.ctx;
        switch (brush.style) {
            case 0: // Qt::NoBrush
                ctx.fillStyle = "rgba(0,0,0,0)"; // no filling
                break;
            case 1: // Qt::SolidPattern
                ctx.fillStyle = brush.color;
                break;

        }
    },
    setupPen:function (pen) {
        var ctx = this.ctx;
        ctx.strokeStyle = pen.color;
        ctx.lineWidth = pen.width;
        ctx.lineJoin = pen.join;
        ctx.miterLimit = pen.miter;
    }
};


function init() {
    wsConnector = new WSConnector('ws://localhost:' + portNumber);
    qtLogic = new QtLogic();
    canvasDrawer = new CanvasDrawer('canvas');
    wsConnector.init();
}

$(document).ready(function () {
    setTimeout(function () {
        init();
    }, 1500);
})

</script>
</head>
<body>
<canvas id="canvas" width="800" height="600">Your browser doesn't support canvas.</canvas>
<div class="data"></div>
</body>
</html>
